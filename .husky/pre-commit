echo "üîç Running accessibility validation on staged files..."

# Get staged story .tsx files only
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.stories\.tsx$' | tr '\n' ' ')

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ No story files to validate"
  exit 0
fi

# Run a11y validation
echo "Validating: $STAGED_FILES"

# Check if validator is built
if [ ! -d "tools/a11y-validator/dist" ]; then
  echo "‚ö†Ô∏è Building a11y-validator..."
  cd tools/a11y-validator && npm run build && cd ../..
fi

# Run validation
npx tsx tools/a11y-validator/src/cli.ts $STAGED_FILES --threshold error

RESULT=$?

if [ $RESULT -ne 0 ]; then
  echo ""
  echo "‚ùå COMMIT BLOQUEADO: Errores de accesibilidad cr√≠ticos/serios encontrados"
  echo ""
  echo "Por favor corrige los errores antes de hacer commit."
  echo "Ejecuta 'npm run a11y:validate' para ver el reporte completo."
  echo ""
  exit 1
fi

echo "‚úÖ Accessibility validation passed"
exit 0
